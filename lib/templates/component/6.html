<div layout="row" layout-padding layout-align="space-between stretch" style="min-height:12rem;">
    <div id="double-knob-{{component.id}}" flex="50"
         class="ratio-content" style="max-height:20em;"
         title="{{component.title}}"></div>

    <div flex="50" style="padding-left:1.2rem;">
        <span ng-if="dataState" style="color: rgba(255,255,255,.5);">
            Currently
            <h2 style="margin: 0.4rem 0; color: rgba(255,255,255,1);">{{ng-open}}dataState.temperature{{ng-close}}</h2>
            {{ng-open}}dataState.light{{ng-close}}
            <br/><br/>
        </span>

        TODO !4: bouton "forcer pendant 2h", couplé au widget en batons (planning, avec possibilité de forcer à confort 2h)
    </div>
</div>

<div flex layout-fill style="padding-top:1.1em;">
    <div id="planer-{{component.id}}" style="width:100%; height:3em;"></div>
</div>

<div flex style="padding-top:1.1em;">
    TODO !4: Travailler sur le planer en barrettes. -> module JQuery. Canvas ?
</div>

{{#extend "settingsForm"}}
  <md-dialog-content style="min-width:700px;max-width:800px;max-height:810px;">

      <form name="componentForm" layout="column" flex layout-fill>
          <section>
              <md-subheader class="md-accent">Heating dashboard - Scenarii piloted</md-subheader>
              <md-list layout="column" layout-padding>
                  <md-list-item layout="row" layout-align="space-between stretch">
                      <md-input-container flex="80">
                          <label>Title</label>
                          <input ng-model="component.configuration.title" required name="component_title" md-maxlength="64" />
                      </md-input-container>
                      <md-select placeholder="Icon" ng-model="component.configuration.icon" style="margin-left: 1rem;" flex="20">
                          <md-option ng-value="">None</md-option>
                          <md-option ng-value="icon" ng-repeat="icon in edition.tools.icons">
                            <md-icon class="material-icons" aria-label="{{ng-open}}icon{{ng-close}}" style="color: #64DD17;">{{ng-open}}icon{{ng-close}}</md-icon>
                          </md-option>
                      </md-select>
                  </md-list-item>
                  <md-list-item layout="row" layout-align="space-between stretch">
                      <md-slider-container flex="50">
                          <h5>Min. temperature (°C)</h5>
                          <md-slider md-discrete ng-model="component.configuration.temp_min_min" min="10" max="35" step="1"
                                     aria-label="Min. temperature"></md-slider>
                      </md-slider-container>
                      <md-slider-container flex="50">
                          <h5>Max. temperature (°C)</h5>
                          <md-slider md-discrete ng-model="component.configuration.temp_max_max" min="15" max="40" step="1"
                                     aria-label="Max. temperature"></md-slider>
                      </md-slider-container>
                  </md-list-item>
              </md-list>
          </section>
          <md-divider></md-divider>
          <section>
              <md-subheader>Scenarii to pilot</md-subheader>
              <md-list layout="column" layout-padding>
                  <md-list-item layout="row" layout-align="space-between stretch">
                      <h4>Scenarii to control the LOWER temperature:</h4>
                  </md-list-item>
                  <md-list-item layout="row" layout-align="space-between stretch">
                      <md-select placeholder="Scenario linked for MIN temperature #1" ng-model="component.configuration.scenarii.min_temp_control_1.id" flex="50" style="margin-right: 0.5rem;">
                          <md-option ng-value="">None</md-option>
                          <md-option ng-value="scenario.id" ng-repeat="scenario in states.activableScenarii">{{ng-open}}scenario.label{{ng-close}}</md-option>
                      </md-select>
                      <md-select placeholder="Scenario linked for MIN temperature #2" ng-model="component.configuration.scenarii.min_temp_control_2.id" flex="50" style="margin-left: 0.5rem;">
                          <md-option ng-value="">None</md-option>
                          <md-option ng-value="scenario.id" ng-repeat="scenario in states.activableScenarii">{{ng-open}}scenario.label{{ng-close}}</md-option>
                      </md-select>
                  </md-list-item>
                  <md-list-item layout="row" layout-align="space-between stretch">
                      <md-select placeholder="Scenario linked for MIN temperature #3" ng-model="component.configuration.scenarii.min_temp_control_3.id" flex="50" style="margin-right: 0.5rem;">
                          <md-option ng-value="">None</md-option>
                          <md-option ng-value="scenario.id" ng-repeat="scenario in states.activableScenarii">{{ng-open}}scenario.label{{ng-close}}</md-option>
                      </md-select>
                      <md-select placeholder="Scenario linked for MIN temperature #4" ng-model="component.configuration.scenarii.min_temp_control_4.id" flex="50" style="margin-left: 0.5rem;">
                          <md-option ng-value="">None</md-option>
                          <md-option ng-value="scenario.id" ng-repeat="scenario in states.activableScenarii">{{ng-open}}scenario.label{{ng-close}}</md-option>
                      </md-select>
                  </md-list-item>
                  <md-list-item layout="row" layout-align="space-between stretch">
                      <h4>Scenarii to control the HIGHER temperature:</h4>
                  </md-list-item>
                  <md-list-item layout="row" layout-align="space-between stretch">
                      <md-select placeholder="Scenario linked for MAX temperature #1" ng-model="component.configuration.scenarii.max_temp_control_1.id" flex="50" style="margin-right: 0.5rem;">
                          <md-option ng-value="">None</md-option>
                          <md-option ng-value="scenario.id" ng-repeat="scenario in states.activableScenarii">{{ng-open}}scenario.label{{ng-close}}</md-option>
                      </md-select>
                      <md-select placeholder="Scenario linked for MAX temperature #2" ng-model="component.configuration.scenarii.max_temp_control_2.id" flex="50" style="margin-left: 0.5rem;">
                          <md-option ng-value="">None</md-option>
                          <md-option ng-value="scenario.id" ng-repeat="scenario in states.activableScenarii">{{ng-open}}scenario.label{{ng-close}}</md-option>
                      </md-select>
                  </md-list-item>
                  <md-list-item layout="row" layout-align="space-between stretch">
                      <md-select placeholder="Scenario linked for MAX temperature #3" ng-model="component.configuration.scenarii.max_temp_control_3.id" flex="50" style="margin-right: 0.5rem;">
                          <md-option ng-value="">None</md-option>
                          <md-option ng-value="scenario.id" ng-repeat="scenario in states.activableScenarii">{{ng-open}}scenario.label{{ng-close}}</md-option>
                      </md-select>
                      <md-select placeholder="Scenario linked for MAX temperature #4" ng-model="component.configuration.scenarii.max_temp_control_4.id" flex="50" style="margin-left: 0.5rem;">
                          <md-option ng-value="">None</md-option>
                          <md-option ng-value="scenario.id" ng-repeat="scenario in states.activableScenarii">{{ng-open}}scenario.label{{ng-close}}</md-option>
                      </md-select>
                  </md-list-item>
                  // TODO !3: listes des scenarii a activer en mode economique only (x4)
                  // TODO !3: listes des scenarii a activer en mode confort only (x4)
              </md-list>
          </section>
          <md-divider></md-divider>
          <section>
              <md-subheader>Data provider (optional)</md-subheader>
              <md-list layout="column" layout-padding>
                  <md-list-item layout="row" layout-align="space-between stretch">
                      <md-select placeholder="Data provider linked" ng-model="component.configuration.data" flex>
                          <md-option ng-value="">None</md-option>
                          <md-option ng-value="id" ng-repeat="(id, data) in states.data.value">{{ng-open}}data.name{{ng-close}}</md-option>
                      </md-select>
                  </md-list-item>
              </md-list>
          </section>
      </form>
  </md-dialog-content>
  <md-dialog-actions layout="row">
    <span flex></span>
    <md-button ng-click="cancelConfig()"><md-icon aria-label="block" class="material-icons md-14">block</md-icon> Cancel</md-button>
    <md-button class="md-primary md-raised" ng-click="preSaveConfig()" md-autofocus><md-icon aria-label="done" class="material-icons md-14">done</md-icon> Save</md-button>
  </md-dialog-actions>
{{/extend}}

<script>
  {{#extend "controllerScript"}}

    ////////////////////////////
    // Default values assignment
    ////////////////////////////

    $scope.component = $scope.edition.tools.assignDeep({
      configuration: {
          title: 'Heating dashboard', icon: '', data: '', // data sensor ID, optional
          temp_min_min: 15,
          temp_max_max: 30,
          temp_min_value: 15,
          temp_max_value: 30,
          scenarii: {
              min_temp_control_1: {id:''}, // master
              min_temp_control_2: {id:''}, // slave
              min_temp_control_3: {id:''}, // slave
              min_temp_control_4: {id:''}, // slave
              max_temp_control_1: {id:''}, // master
              max_temp_control_2: {id:''}, // slave
              max_temp_control_3: {id:''}, // slave
              max_temp_control_4: {id:''} // slave
          }
      }
    }, $scope.component)

    ////////////////////////////
    // MIN MAX temperature pilot
    ////////////////////////////

    // scenarii config watchers: when scenario is changed from settings, look into for data to control.
    const scenarioConfiguratorGenerator = (configPath, isMin, isMaster) => {
      const configurator = function(newId, oldId) {
        const scenarioConf = _.get($scope.component.configuration, configPath)
        if (!newId || newId === '' || newId === oldId) {
            return
        }
console.log("##", scenarioConf);
        // TODO !1: une procédure de reconnaissance de la donnée à controller doit être faite chez Myfox
        // via edition du scenarii en ajax. Le but est d'identifier la donner à controler
      }
      this.addCleaner($scope.$watch('component.configuration.' + configPath + '.id', configurator))
    }
    scenarioConfiguratorGenerator('scenarii.min_temp_control_1', true, true)
    scenarioConfiguratorGenerator('scenarii.min_temp_control_2', true, false)
    scenarioConfiguratorGenerator('scenarii.min_temp_control_3', true, false)
    scenarioConfiguratorGenerator('scenarii.min_temp_control_4', true, false)
    scenarioConfiguratorGenerator('scenarii.max_temp_control_1', false, true)
    scenarioConfiguratorGenerator('scenarii.max_temp_control_2', false, false)
    scenarioConfiguratorGenerator('scenarii.max_temp_control_3', false, false)
    scenarioConfiguratorGenerator('scenarii.max_temp_control_4', false, false)

    // Double knob widget
    const amplitude = $scope.component.configuration.temp_max_max - $scope.component.configuration.temp_min_min + 0.0
    $scope.doubleKnob = $('div#double-knob-{{component.id}}').temperatureLoader({
		minValue: $scope.component.configuration.temp_min_value || $scope.component.configuration.temp_min_min,
		maxValue: $scope.component.configuration.temp_max_value || $scope.component.configuration.temp_max_max,
		scaleOffset: $scope.component.configuration.temp_min_min + 0.0,
		scaleAmplitude: amplitude,
        title: 'Min/Max',
		precision: (amplitude > 5) ? 0 : 1,
		onMinUpdate: function (old, value) { console.log(value) },
		onMaxUpdate: function (old, value) { console.log(value) },
		/*onCenterClick: onCenterClick,
		onUpdating: onUpdating,
		componentData: component*/
	});
    $scope.edition.tools.addAutoRescaler($scope.doubleKnob.resizer)

    ///////////////////////////
    // Planer eco/confort pilot
    ///////////////////////////

    $('div#planer-{{component.id}}').autoSizedPlaner({
      // TODO !4
	});

    //////////////////////////////////
    // Data provider (temp, lightning)
    //////////////////////////////////

    if ($scope.component.configuration && $scope.component.configuration.data > 0) {
      $scope.dataState = null;
      $scope.updateDataProvider = function (data) {
        $scope.dataState = data
      }
      this.addCleaner($scope.$watch('states.data.value[' + $scope.component.configuration.data + ']', $scope.updateDataProvider))
    }
  {{/extend}}

  {{#extend "settingsScript"}}
    $scope.preSaveConfig = function () {
      // TODO !2: sur temp_min_min et temp_max_max: s'ils changent,
      // il faut vérifier temp_min_value et temp_max_value: doivent rester dans l'intervalle, sinon, fixer les scenarii correspondants.

      // TODO !1: boucler sur les scenarii [min/max]_temp_control_[X] et fixer:
      // Si MASTER (X==1) alors on doit prendre en compte la valeur et la mettre dans temp_min_value / temp_max_value (valeurs courantes)
      // Control supp: si la valeur est hors [temp_min_min, temp_max_max], alors corriger la valeur dans le scenario.
      // Si SLAVE (X>1) alors on doit modifier la valeur dans le scenario pour l'aligner avec le master.
      $scope.saveConfig()
    };
  {{/extend}}
</script>
