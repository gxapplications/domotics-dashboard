<div class="sub-loader" ng-show="processingState === 'processing'">
    <div flex layout="row" layout-align="center center">
        <md-progress-circular md-diameter="64" md-mode="indeterminate" class="md-hue-3"></md-progress-circular>
    </div>
    <div style="position: relative; bottom: 2.7rem; height: 0px; overflow: visible;">
        <md-icon class="material-icons" aria-label="RATP RER">train</md-icon>
    </div>
</div>
<div class="sub-content" ng-show="processingState === 'waiting'">
    <div flex layout="row" layout-align="center center"></div>
</div>
<div class="sub-content" ng-show="processingState === 'error'">
    <div flex layout="row" layout-align="center center">
        TODO !4
    </div>
</div>

{{#extend "settingsForm"}}
  <md-dialog-content style="min-width:700px;max-width:800px;max-height:810px;">
      <form name="componentForm" layout="column" flex layout-fill>
          <section>
              <md-subheader class="md-accent">RATP RER timetable parser</md-subheader>
              <md-list layout="column" layout-padding>
                  <md-list-item layout="row" layout-align="space-between stretch">
                      <md-input-container flex="80">
                          <label>Title</label>
                          <input ng-model="component.configuration.title" required name="component_title" md-maxlength="64" />
                      </md-input-container>
                      <md-select placeholder="Icon" ng-model="component.configuration.icon" style="margin-left: 1rem;" flex="20">
                          <md-option ng-value="icon" ng-repeat="icon in edition.tools.icons">
                            <md-icon class="material-icons" aria-label="{{ng-open}}icon{{ng-close}}" style="color: #64DD17;">{{ng-open}}icon{{ng-close}}</md-icon>
                          </md-option>
                      </md-select>
                  </md-list-item>
                  <md-list-item>
                      <md-input-container flex>
                          <label>URL</label>
                          <input ng-model="component.configuration.url" md-maxlength="256" />
                      </md-input-container>
                  </md-list-item>
              </md-list>
          </section>
          <md-divider></md-divider>
      </form>
  </md-dialog-content>
  <md-dialog-actions layout="row">
    <span flex></span>
    <md-button ng-click="cancelConfig()"><md-icon aria-label="block" class="material-icons md-14">block</md-icon> Cancel</md-button>
    <md-button class="md-primary md-raised" ng-click="saveConfig()" md-autofocus><md-icon aria-label="done" class="material-icons md-14">done</md-icon> Save</md-button>
  </md-dialog-actions>
{{/extend}}

<script>
  {{#extend "controllerScript"}}
    // Default values assignment
    $scope.component = $scope.edition.tools.assignDeep({
      configuration:
        {title: 'RATP ~ RER', icon: 'train', url: 'http://www.ratp.fr/horaires/fr/ratp/rer/prochains_passages/RA/Bussy+St-Georges/A'}
    }, $scope.component)

    // to control state
    $scope.processingState = 'processing' // or 'waiting', 'error'

    $scope.loadContent = function() {
      $scope.processingState = 'processing'
      $.post('/{{page.slug}}/component/{{component.id}}/action', {})
        .done(function(data) {
          $scope.processingState = 'waiting'
          // TODO !2 : afficher data correctement !
        })
        .fail(function() {
          $scope.processingState = 'error'
          // TODO !3 ?
        })
    }

    $document.ready(() => {
      $scope.loadContent() // FIXME !4: ca se lance 2 fois au refresh du component (fermeture settings)
    })
  {{/extend}}
</script>
